<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BasuRANT — Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./BasuRANT.css">
</head>
<body>
    <div class="login-page">
        

        <main class="login-card" role="main">
            <h1>BasuRANT</h1>
            <p class="muted">Turn civic reports into measurable cleanup action</p>


    

            <div style="margin-top:12px;">
                <button id="admin-btn" class="admin-btn" style="width:100%;">Admin Login</button>
            </div>

            <p style="font-size:0.9em; color:var(--muted); margin-top:16px;">By continuing you agree to the platform terms and local policies.</p>
        </main>

        <div id="admin-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-content">
                <span class="close" id="admin-close">×</span>
                <h2>Admin Sign In</h2>
                <form id="admin-login-form">
                    <div class="form-group">
                        <label for="admin-email">Email</label>
                        <input type="email" id="admin-email" required placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label for="admin-password">Password</label>
                        <input type="password" id="admin-password" required placeholder="Enter password">
                    </div>
                    <button type="submit">Sign in</button>
                    <p id="admin-error" style="color:#B00020; display:none; margin-top:10px;"></p>
                    <p style="margin-top:10px; font-size:0.9em; color:var(--muted);">(Demo: you can use <code>admin@example.com</code> / <code>password</code>)</p>
                </form>
            </div>
        </div>

    </div>

    <script src="./BasuRANT.js"></script>
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
            import { getFirestore, initializeFirestore } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyA_USj1JdYEiO6w7iEXx7i-fmcZi4eqayM",
                authDomain: "basurant-ae691.firebaseapp.com",
                projectId: "basurant-ae691",
                storageBucket: "basurant-ae691.firebasestorage.app",
                messagingSenderId: "68560863095",
                appId: "1:68560863095:web:3d0792e4cd2823c48b2b72",
                measurementId: "G-M74R54N0J3"
            };

                    const app = initializeApp(firebaseConfig);
                    const db = initializeFirestore ? initializeFirestore(app, { experimentalForceLongPolling:true, useFetchStreams:false }) : getFirestore(app);
                    const auth = getAuth(app);
                    let authReady = false;
                    // Attempt anonymous sign-in so reads that require auth succeed
                    signInAnonymously(auth).then(cred => {
                        console.log('Anonymous sign-in successful', cred.user && cred.user.uid);
                    }).catch(err => {
                        console.warn('Anonymous sign-in failed', err && err.code, err && err.message);
                    });
                    onAuthStateChanged(auth, user => { authReady = !!user; console.debug('Auth state changed, ready=', authReady, user && user.uid); });

            // Safely replace the admin form to remove previously attached listeners then attach our Firestore-backed submit handler
            document.addEventListener('DOMContentLoaded', function(){
                const oldForm = document.getElementById('admin-login-form');
                if (!oldForm) return;
                const newForm = oldForm.cloneNode(true); // clones inputs but not event listeners
                oldForm.parentNode.replaceChild(newForm, oldForm);

                const errorEl = document.getElementById('admin-error');
                const adminModal = document.getElementById('admin-modal');

                        newForm.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const email = document.getElementById('admin-email')?.value?.trim();
                    const pass = document.getElementById('admin-password')?.value || '';
                    if (!email || !pass) {
                        if (errorEl) { errorEl.textContent = 'Please enter email and password.'; errorEl.style.display = 'block'; }
                        return;
                    }

                    try {
                                // Wait up to ~3s for auth to be ready
                                const start = Date.now();
                                while (!authReady && Date.now() - start < 3000) await new Promise(r => setTimeout(r, 100));

                                // Use Firebase Authentication to sign the admin in.
                                // This avoids reading protected Firestore documents and relies on Firebase Auth security.
                                try {
                                    const cred = await signInWithEmailAndPassword(auth, email, pass);
                                    // success — set a simple session flag and redirect
                                    sessionStorage.setItem('basurant_admin', JSON.stringify({ uid: cred.user.uid, email }));
                                    window.location.href = './BasuRANT.html';
                                } catch (err) {
                                    console.error('Admin sign-in error', err);
                                    if (errorEl) {
                                        let message = 'Login error: ' + (err?.message || err);
                                        // Friendly messages for common auth errors
                                        if (err && err.code === 'auth/wrong-password') message = 'Invalid email or password.';
                                        if (err && err.code === 'auth/user-not-found') message = 'Account not found.';
                                        errorEl.textContent = message;
                                        errorEl.style.display = 'block';
                                    }
                                }
                    } catch (err) {
                        console.error('Admin login error', err);
                        if (errorEl) { errorEl.textContent = 'Login error: ' + (err?.message || err); errorEl.style.display = 'block'; }
                    }
                });

                // wire up modal close (ensure it still works)
                const adminClose = document.getElementById('admin-close');
                if (adminClose && adminModal) {
                    adminClose.addEventListener('click', function(){ adminModal.style.display = 'none'; adminModal.setAttribute('aria-hidden','true'); if (errorEl) errorEl.style.display='none'; });
                }
            });


            fetch('http://localhost:4000/users?maxResults=100', {
  headers: { 'x-api-key': 'supersecret' }
}).then(r => r.json()).then(console.log).catch(console.error);
        </script>
</body>
</html>